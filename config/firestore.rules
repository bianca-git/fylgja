rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Users can only access their own data
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      // User interactions (conversations, check-ins)
      match /interactions/{interactionId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
      
      // User tasks and reminders
      match /tasks/{taskId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
      
      // Legacy data (encrypted client-side)
      match /legacyData/{docId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
      
      // User preferences and settings
      match /preferences/{docId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }
    
    // Scheduled messages (system access only)
    match /scheduled_messages/{messageId} {
      allow read, write: if false; // Only accessible via Cloud Functions
    }
    
    // System logs and analytics (admin access only)
    match /system_logs/{logId} {
      allow read, write: if false; // Only accessible via Cloud Functions
    }
    
    // Error logs (system access only)
    match /errors/{errorId} {
      allow read, write: if false; // Only accessible via Cloud Functions
    }
    
    // Webhook logs (system access only)
    match /webhook_logs/{logId} {
      allow read, write: if false; // Only accessible via Cloud Functions
    }
    
    // Public data (read-only for authenticated users)
    match /public/{docId} {
      allow read: if request.auth != null;
      allow write: if false; // Only writable via Cloud Functions
    }
  }
}

